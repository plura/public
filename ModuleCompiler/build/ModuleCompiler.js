/**
 * Plura ModuleCompiler Javascript Framework [http://plura.pt]
 * 
 * Copyright (c) 2023 Plura
 *
 * Date: 2023-01-07 18:19:00 (Sat, 07 Jan 2023)
 * Revision: 6246
 */
'use strict';const ModuleCompiler=function({data:x,prefix:y,process:h="ModuleCompiler.php"}){let b,n,r,w,t,e,d,m;const c=this,g=p=>{t.refresh(p.tree);d.refresh(p.result)},q=p=>{d.refresh(p.result);m.set("loading",!1)},f=p=>{p.stopImmediatePropagation();switch(p.type){case "COLLECTIONS":t.start(n.collection(p.detail));break;case "GROUPS_SELECT":r=p.detail.id;e.refresh(n.type(r),n.returnTypes(r));n.load(r,g,e.get());break;case "FILES":case "PREFERENCES":m.set("loading",e.wait()),n.load(r,q,e.get(),
t.get())}};n=new ModuleDataManager({data:x,handler:p=>{b||(c.core=b=document.body.appendChild(document.createElement("div"))).classList.add("p-app-modulecompiler");w=new ModuleCompilerFilterCollection({data:p.filter(),prefix:"p-app-modulecompiler",target:b});w.core.addEventListener("COLLECTIONS",f);e=new ModuleCompilerPreferences({target:b,prefix:"p-app-modulecompiler"});e.core.addEventListener("PREFERENCES",f);t=new ModuleCompilerFileManager({prefix:"p-app-modulecompiler",target:b});["FILES","GROUPS_SELECT"].forEach(v=>
t.core.addEventListener(v,f));d=new ModuleCompilerResultManager({prefix:"p-app-modulecompiler",target:b});m=new ModuleCompilerSystemStatus({app:c,prefix:"p-app-modulecompiler",target:b})},prefix:y,process:h})},ModuleCompilerFileManagerGroup=function({data:x,target:y}){var h,b,n,r,w;const t=(m,c=!0,g=!0)=>{m?r.classList.add("on"):r.classList.remove("on");c&&d.activate(m,g);b=m},e=m=>{m?[h,w].forEach(c=>c.classList.add("on")):[h,w].forEach(c=>c.classList.remove("on"));n=m;h.dispatchEvent(new CustomEvent("GROUP_VISIBILITY",
{detail:{visibility:n}}))};(h=y.appendChild(document.createElement("div"))).classList.add(...["files-group","on"]);(y=h.appendChild(document.createElement("div"))).classList.add("controls");(r=y.appendChild(document.createElement("div"))).classList.add(...["control","controls-check"]);r.addEventListener("click",m=>t(!b));r.textContent=x.name||x.path;t(!0,!1);(w=y.appendChild(document.createElement("div"))).classList.add(...["control","controls-visibility"]);w.addEventListener("click",m=>e(!n));e(!0);
y=void 0;var d=new ModuleCompilerFileManagerGroupTree({data:x.core,target:h});d.core.addEventListener("GROUP_TREE_CHANGE",m=>t(d.active(),!1));this.active=d.active;this.check=t;this.core=h;this.show=e;this.visible=()=>n},ModuleCompilerFileManagerGroupsNav=function({target:x}){let y,h,b,n,r,w,t,e,d,m,c;const g=u=>{e.core.querySelector("select").value=u;[...t.children].forEach((A,B)=>{u===B?(A.classList.add("active"),A.removeEventListener("click",a)):(A.classList.remove("active"),A.addEventListener("click",
a))})},q=u=>{let A=[],B;n=new Map;(t=document.createElement("div")).classList.add("index");u.forEach((C,D)=>{A.push({name:C.name,value:D});(B=t.appendChild(document.createElement("div"))).classList.add("i");n.set(B,D)});e=new ModuleCompilerForm({data:[{type:"select",values:A,change:k,blank:!1}],target:h});h.appendChild(t)},f=(u=0)=>{u!==y&&(1<b.length&&g(u),y=u,h.dispatchEvent(new CustomEvent("GROUPS_SELECT",{bubbles:!0,detail:b[u]})));1<b[u].items.length?h.appendChild(d):d.isConnected&&h.removeChild(d)},
p=(u,A=!0)=>{u?m.classList.add("on"):m.classList.remove("on");r=u;A&&h.dispatchEvent(new CustomEvent("GROUPS_CHECK",{detail:{check:r}}))},v=(u,A=!0)=>{u?c.classList.add("on"):c.classList.remove("on");w=u;A&&h.dispatchEvent(new CustomEvent("GROUPS_VISIBILITY",{detail:{visibility:w}}))},a=u=>f(n.get(u.currentTarget)),k=({element:u})=>f(Number(u.value)),l=u=>p(!r),z=u=>v(!w);(h=x.appendChild(document.createElement("div"))).classList.add("files-group-nav");this.core=h;this.check=p;this.refresh=u=>{for(;h.firstChild;)h.removeChild(h.firstChild);
y=null;b=u;1<b.length&&q(b);(d=document.createElement("div")).classList.add("controls");(m=d.appendChild(document.createElement("div"))).classList.add(...["control","controls-check"]);m.addEventListener("click",l);p(!0,!1);(c=d.appendChild(document.createElement("div"))).classList.add(...["control","controls-visibility"]);c.addEventListener("click",z);v(!0,!1);f()};this.show=v},ModuleCompilerFileManagerGroupTree=function({data:x,target:y}){let h,b,n,r,w;const t=(a,k=!0)=>{k&&!r.has(a)?(r.set(a,b.get(a).data),
n.delete(a)):k||n.has(a)||(n.set(a,b.get(a).data),r.delete(a));b.get(a).parents&&b.get(a).parents.forEach(l=>{var z;if(!(z=k)&&(z=!k)){a:{z=b.get(l).children;let u;for(u=0;u<z.length;u+=1)if(r.has(z[u])){z=!0;break a}z=!1}z=!z}z&&e(l,k,!1)});d(a,k)},e=(a,k=!0,l=!0)=>{l&&b.get(a).children.forEach(z=>{b.get(z).children?e(z,k):t(z,k)});d(a,k)},d=(a,k)=>{k?b.get(a).node.classList.add("on"):b.get(a).node.classList.remove("on")},m=(a=!0)=>a&&r.size||!a&&n.size?a?r:n:!1,c=()=>({active:m(),inactive:m(!1),
leaf:w.size,selected:r.size}),g=(a,k)=>{k=void 0!==k?k:b.get(a).children?!b.get(a).node.classList.contains("on"):!r.has(a);b.get(a).children?e(a,k):t(a,k)},q=(a,k)=>{let l,z=k?k+"_":"i",u,A,B;u=document.createElement("ul");a.forEach((C,D)=>{l=z+D;(A=u.appendChild(document.createElement("li"))).classList.add(...["node",l]);(B=A.appendChild(f(C))).classList.add("trigger");b.set(l,{data:C,node:A});b.set(A,l);C.children?(A.appendChild(q(C.children,l)).classList.add("branch"),B.addEventListener("click",
p)):(A.addEventListener("click",v),A.classList.add("leaf"),w.set(A,C));k?(l.split("_").slice(0,-1).forEach((G,E,F)=>(b.get(l).parents=b.get(l).parents||[]).push(F.slice(0,E+1).join("_"))),(b.get(k).children=b.get(k).children||[]).push(l)):g(l)});return u},f=a=>{let k="string"===typeof a?a:a.name||a.vanity,l=document.createElement("span");l.textContent=k;a.path&&l.setAttribute("data-path",a.path);return l},p=a=>{a=b.get(a.currentTarget.parentNode);g(a);h.dispatchEvent(new CustomEvent("GROUP_TREE_CHANGE",
{bubbles:!0,detail:c()}))},v=a=>{a=b.get(a.currentTarget);g(a);h.dispatchEvent(new CustomEvent("GROUP_TREE_CHANGE",{bubbles:!0,detail:c()}))};this.activate=(a=!0,k=!0)=>{x.forEach((l,z)=>g(`i${z}`,a));k&&h.dispatchEvent(new CustomEvent("GROUP_TREE_CHANGE",{bubbles:!0,detail:c()}))};this.active=m;b=new Map;n=new Map;r=new Map;w=new Map;(h=y.appendChild(q(x))).classList.add("tree");this.core=h},ModuleCompilerFileManager=function({prefix:x,target:y}){let h,b,n,r;const w=e=>{e.stopImmediatePropagation();
switch(e.type){case "GROUPS_CHECK":b.forEach(d=>d.check(e.detail.check,!0,!1));h.dispatchEvent(new CustomEvent("FILES"));break;case "GROUPS_VISIBILITY":b.forEach(d=>d.show(e.detail.visibility))}},t=e=>{e.stopImmediatePropagation();switch(e.type){case "GROUP_TREE_CHANGE":let d=[];b.forEach(c=>{c.active()||d.push(c)});n.check(d.length!==b.length,!1);h.dispatchEvent(new CustomEvent("FILES"));break;case "GROUP_VISIBILITY":let m=[];b.forEach(c=>{c.visible()||m.push(c)});n.show(m.length!==b.length,!1)}};
(h=y.appendChild(document.createElement("div"))).classList.add(`${x}-files`);n=new ModuleCompilerFileManagerGroupsNav({target:h});["GROUPS_CHECK","GROUPS_VISIBILITY"].forEach(e=>n.core.addEventListener(e,w));(r=h.appendChild(document.createElement("div"))).classList.add("inner");this.core=h;this.get=()=>{let e=[],d;b.forEach((m,c)=>{if(m.active()){if(d=m.active(!1),e[c]={},d){e[c].exclude=[];for(const g of d.values())e[c].exclude.push(g.path||g)}}else e[c]=!1});return e};this.refresh=e=>{for(b=[];r.firstChild;)r.removeChild(r.firstChild);
e.forEach((d,m)=>{b[m]=new ModuleCompilerFileManagerGroup({data:d,target:r});["GROUP_TREE_CHANGE","GROUP_VISIBILITY"].forEach(c=>b[m].core.addEventListener(c,t))})};this.start=e=>{n.refresh(e.groups);h.setAttribute("data-title",e.label)}},ModuleCompilerFilterCollection=function({data:x,prefix:y,target:h}){let b;(b=h.appendChild(document.createElement("div"))).classList.add(`${y}-collections`);new ModuleCompilerForm({target:b,data:[{type:"select",values:x,change:({element:n})=>{b.dispatchEvent(new CustomEvent("COLLECTIONS",
{detail:n.value}))}}]});this.core=b},ModuleCompilerFormLabelAlign={LEFT:"left",LEFT_WRAP:"left-wrap",RIGHT:"right",RIGHT_WRAP:"right-wrap"},ModuleCompilerForm=function({data:x,target:y}){let h,b;const n=this,r=(c,g)=>{c.forEach(q=>{let f;if(q instanceof Array||q.type.match(/(field)?set/))f=g.appendChild(document.createElement(q.tag||"fieldset")),r(q.fields||q,f);else{switch(q.type){case "select":f=w({elementData:q.values,blank:q.blank});break;default:f=document.createElement("input")}f.classList.add("p-modulecompiler-form-element")}g.appendChild(f);
void 0!==q.label&&t(q.label,f);e(f,q)})},w=({elementData:c,elementParent:g,elementParentID:q,blank:f=!0})=>{let p=g||document.createElement("select");!g&&f&&p.appendChild(document.createElement("option"));c.forEach((v,a)=>{let k=`${q?`${q}_`:"i"}${a}`,l;v.values||v instanceof Array?(l=v.values&&(v.label||v.name)?v.label||v.name:`group${a}`,v=v.values||v,(a=p.appendChild(document.createElement("optgroup"))).setAttribute("label",l),w({elementData:v,elementParent:a,elementParentID:k})):(l=m([v.label,
v.name,v.value,v]),(a=p.appendChild(document.createElement("option"))).value=m([v.value,l]),a.textContent=l,b.set(a,k))});return p},t=(c,g,q=ModuleCompilerFormLabelAlign.LEFT)=>{q=c.align||q;let f=document.createElement("label"),p=`p-modulecompiler-form-element-${Date.now()+Math.floor(256*Math.random())}`;d(g,{id:p});d(f,{"for":p,"align-type":q});f.textContent=c.name||c;switch(q){case ModuleCompilerFormLabelAlign.LEFT:g.parentNode.insertBefore(f,g);break;case ModuleCompilerFormLabelAlign.LEFT_WRAP:g.parentNode.appendChild(f).appendChild(g);
break;case ModuleCompilerFormLabelAlign.RIGHT:g.parentNode.insertBefore(f,g.nextSibling);break;case ModuleCompilerFormLabelAlign.RIGHT_WRAP:g.parentNode.appendChild(f).prepend(g)}f.classList.add(`align-${q}`);return f},e=(c,g)=>{let q={};if(!g.type||g.type.match(/((field)?set|checkbox|radio|text)/))if(!g.type.match(/(field)?set/)||g.tag)q.type=g.type||"text";void 0!==g.name&&(q.name=g.name);void 0!==g.change&&c.addEventListener("change",f=>g.change({data:g,form:h,element:c,obj:n}));void 0!==g.value&&
(q.value=g.value);g.type.match(/(checkbox|radio)/)&&g.checked&&(q.checked=!0);d(c,q)},d=(c,g)=>Object.entries(g).forEach(([q,f])=>c.setAttribute(q,f)),m=c=>{let g;for(const q of c)if(g=q,void 0!==g)break;return g};x&&(b=new Map,n.core=h=y.appendChild(document.createElement("form")),r(x,h))},ModuleCompilerPreferences=function({prefix:x,target:y}){let h,b;const n="ECMASCRIPT_2021 ECMASCRIPT_2020 ECMASCRIPT_2019 ECMASCRIPT_2018 ECMASCRIPT_2017 ECMASCRIPT_2016 ECMASCRIPT6 ECMASCRIPT5".split(" "),r=()=>
{let d={returnType:t("[name=returnType]:checked").value};d.returnType.match(/join/)&&t("[name=minify]").checked&&(d={...d,minify:1,language:t("[name=language]").value,language_out:t("[name=language_out]").value});return d},w=({type:d,returnTypes:m}={})=>{m&&t("[name=returnType]",!0).forEach(c=>{c.disabled=!m.includes(c.value)});t("[type=set]:not([name=main])",!0).forEach(c=>{t("[name=returnType]:checked").value===c.getAttribute("name")?c.classList.add("on"):c.classList.remove("on")});["language",
"language_out"].forEach(c=>{c=t(`[name="join"] [name=${c}]`);c.disabled=!t('[name="join"] [name=minify]').checked;if(d)c.classList[d.match(/js/)?"remove":"add"]("off")});b.core.querySelectorAll("[id]").forEach(c=>{let g=t(`label[for=${c.id}]`),q;g&&(q=[[c.disabled?"add":"remove","disabled"]],d&&q.push([c.classList.contains("off")?"add":"remove","off"]),q.forEach(f=>g.classList[f[0]](f[1])))})},t=(d,m=!1)=>b.core[m?"querySelectorAll":"querySelector"](d),e=d=>{w();d=r("minify").checked;h.dispatchEvent(new CustomEvent("PREFERENCES",
{detail:{load:d}}))};(h=y.appendChild(document.createElement("div"))).classList.add(`${x}-preferences`);b=new ModuleCompilerForm({target:h,data:[{type:"set",name:"main",tag:"div",fields:[{name:"returnType",type:"radio",label:{name:"Link",align:"right"},value:"link",checked:!0,change:e},{name:"returnType",type:"radio",label:{name:"Join",align:"right"},value:"join",change:e},{name:"returnType",type:"radio",label:{name:"Closure",align:"right"},value:"closure",change:e}]},{type:"set",name:"join",tag:"div",
fields:[{name:"minify",type:"checkbox",label:{name:"Minify",align:ModuleCompilerFormLabelAlign.RIGHT_WRAP},change:e},{name:"language",type:"select",values:n,blank:!1,label:{name:"Language",align:ModuleCompilerFormLabelAlign.LEFT_WRAP},change:e},{name:"language_out",type:"select",values:n,blank:!1,label:{name:"Language Out",align:ModuleCompilerFormLabelAlign.LEFT_WRAP},change:e}]}]});w();this.core=h;this.get=r;this.refresh=(d,m)=>w({type:d,returnTypes:m});this.wait=()=>r().minify},ModuleCompilerResultManager=
function({prefix:x,target:y}){var h,b,n;const r={compiled_code:"Compiled Code",errors:"Errors",result:"Result",warnings:"Warnings",statistics:"Statistics"},w=(e,d=!0)=>{if(!d||d&&e!==h){d&&(h&&w(h,!1),h=e);let m=n.get(e).nav.classList;e=n.get(e).content.classList;d?(m.add("active"),e.add("on")):(m.remove("active"),e.remove("on"))}},t=e=>{h=void 0;for(n=new Map;b.firstChild;)b.removeChild(b.firstChild);let d,m,c,g,q;(d=b.appendChild(document.createElement("ul"))).classList.add(`${x}-result-nav`);(g=
b.appendChild(document.createElement("div"))).classList.add(`${x}-result-content`);Object.entries(e).forEach(([f,p])=>{(m=d.appendChild(document.createElement("li"))).classList.add(`${x}-result-nav-item`);(c=m.appendChild(document.createElement("a"))).textContent=r[f]||f;c.setAttribute("href","#");c.addEventListener("click",v=>w(v.currentTarget));(q=g.appendChild(document.createElement("div"))).classList.add(`${x}-result-content-item`);q.appendChild(document.createElement("textarea")).textContent=
p;n.set(c,{nav:m,content:q})})};(b=y.appendChild(document.createElement("div"))).classList.add(`${x}-result`);this.refresh=e=>{t("string"===typeof e?{result:e}:e);w(n.keys().next().value)}},ModuleCompilerSystemStatus=function({app:x,prefix:y,target:h}){let b;(b=h.appendChild(document.createElement("div"))).classList.add(`${y}-systemstatus`);b.appendChild(document.createElement("div")).classList.add(`${y}-systemstatus-indicator`);this.set=(n,r=!0)=>{b.classList[r?"add":"remove"]("on");x.core.classList[r?
"add":"remove"](`status-${n}`)}},ModuleDataManager=function({data:x,handler:y,prefix:h,process:b}){var n,r;let w,t,e;const d=this,m=(f,...p)=>{let v=new FormData;p.forEach(a=>{for(let k in a)if(a.hasOwnProperty(k)){let l=a[k];"object"===typeof l&&(l=JSON.stringify(l));v.append(k,l)}});return new Request(f,{body:v,method:"POST"})},c=async f=>{n=new Map;r=new Map;w=new Map;t=new Map;"object"===typeof f?e=g(f):"string"===typeof f&&(e=await fetch(f).then(p=>p.json()).then(p=>g(p)));y&&y(d)},g=(f,p)=>
{let v=[];f.forEach((a,k)=>{let l=`${p?`${p}_`:"i"}${k}`;if(a.values||Array.isArray(a))k=g(a.values||a,l),v.push({name:a.label,values:k});else{let z=[],u;k=a.data;let A=["join","link"];Array.isArray(k)&&(Array.isArray(k[0])||k[0].group&&k[0].items)?k.forEach((B,C)=>{u={id:l+"_"+C,type:B.type||a.type||"js",name:B.group||"Group "+C,items:Array.isArray(B)?B:Array.isArray(B.items)?B.items:[B.items]};z.push(u);q(u)}):(u={id:l+"_0",type:a.type||"js",name:"Group 0",items:Array.isArray(k)?k:[k]},z.push(u),
q(u));z.forEach(B=>{t.set(B.id,B);B.returnTypes=[].concat(A);for(let C=0;C<B.items.length;C+=1)if(B.items[C].closure){B.returnTypes.push("closure");break}});w.set(l,{groups:z,label:a.label});v.push({name:a.label,value:l})}});void 0===p&&r.forEach((a,k)=>{n.has(k)?a.forEach(l=>{l.group.items[l.index]=n.get(k)}):console.log(`ModuleCompiler: alias '${k}' not found.`)});return v},q=f=>{f.items.forEach((p,v)=>{if("string"===typeof p){let a=r;a.has(p)||a.set(p,[]);a.set(p,[...a.get(p),{group:f,index:v}])}else p.alias&&
n.set(p.alias,p)})};d.load=(f,p,v,a)=>{let k=[];f=t.get(f);f.items.forEach((l,z)=>{a&&!a[z]||k.push({exclude:a&&a[z].exclude,filter:l.filter,join:l.join,name:l.name,path:(h||"")+l.path,prefix:v.returnType.match(/link/)&&l[v.returnType]||"",top:l.top})});f=m(b,v,{data:k,type:f.type});fetch(f).then(l=>l.json()).then(l=>p(l))};d.filter=()=>e;d.collection=f=>w.get(f);d.returnTypes=f=>t.get(f).returnTypes;d.type=f=>t.get(f).type;x&&c(x)};
