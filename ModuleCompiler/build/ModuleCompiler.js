/**
 * Plura ModuleCompiler Javascript Framework [http://plura.pt]
 * 
 * Copyright (c) 2023 Plura
 *
 * Date: 2023-01-06 18:19:00 (Fri, 06 Jan 2023)
 * Revision: 6246
 */
'use strict';const ModuleCompiler=function({data:x,prefix:y,process:h="ModuleCompiler.php"}){let b,r,n,w,t,c,d,p;const e=this,g=q=>{t.refresh(q.tree);d.refresh(q.result)},m=q=>{d.refresh(q.result);p.set("loading",!1)},f=q=>{q.stopImmediatePropagation();switch(q.type){case "COLLECTIONS":t.start(r.collection(q.detail));break;case "GROUPS_SELECT":n=q.detail.id;c.refresh(r.type(n),r.returnTypes(n));r.load(n,g,c.get());break;case "FILES":case "PREFERENCES":p.set("loading",c.wait()),r.load(n,m,c.get(),
t.get())}};r=new ModuleDataManager({data:x,handler:q=>{b||(e.core=b=document.body.appendChild(document.createElement("div"))).classList.add("p-app-modulecompiler");w=new ModuleCompilerFilterCollection({data:q.filter(),prefix:"p-app-modulecompiler",target:b});w.core.addEventListener("COLLECTIONS",f);c=new ModuleCompilerPreferences({target:b,prefix:"p-app-modulecompiler"});c.core.addEventListener("PREFERENCES",f);t=new ModuleCompilerFileManager({prefix:"p-app-modulecompiler",target:b});["FILES","GROUPS_SELECT"].forEach(v=>
t.core.addEventListener(v,f));d=new ModuleCompilerResultManager({prefix:"p-app-modulecompiler",target:b});p=new ModuleCompilerSystemStatus({app:e,prefix:"p-app-modulecompiler",target:b})},prefix:y,process:h})},ModuleCompilerFileManagerGroup=function({data:x,target:y}){var h,b,r,n,w;const t=(p,e=!0,g=!0)=>{p?n.classList.add("on"):n.classList.remove("on");e&&d.activate(p,g);b=p},c=p=>{p?[h,w].forEach(e=>e.classList.add("on")):[h,w].forEach(e=>e.classList.remove("on"));r=p};(h=y.appendChild(document.createElement("div"))).classList.add(...["files-group",
"on"]);(y=h.appendChild(document.createElement("div"))).classList.add("controls");(n=y.appendChild(document.createElement("div"))).classList.add(...["control","controls-check"]);n.addEventListener("click",p=>t(!b));n.textContent=x.name||x.path;t(!0,!1);(w=y.appendChild(document.createElement("div"))).classList.add(...["control","controls-visibility"]);w.addEventListener("click",p=>c(!r));c(!0);y=void 0;var d=new ModuleCompilerFileManagerGroupTree({data:x.core,target:h});d.core.addEventListener("GROUP_TREE_CHANGE",
p=>t(d.active(),!1));this.active=d.active;this.check=t;this.core=h;this.visible=c},ModuleCompilerFileManagerGroupsNav=function({target:x}){let y,h,b,r,n,w,t,c,d,p,e;const g=u=>{let A=[],B;r=new Map;(t=document.createElement("div")).classList.add("index");u.forEach((C,D)=>{A.push({name:C.name,value:D});(B=t.appendChild(document.createElement("div"))).classList.add("i");r.set(B,D)});c=new ModuleCompilerForm({data:[{type:"select",values:A,change:k,blank:!1}],target:h});h.appendChild(t)},m=(u=0)=>{u!==
y&&(1<b.length&&f(u),y=u,h.dispatchEvent(new CustomEvent("GROUPS_SELECT",{bubbles:!0,detail:b[u]})));1<b[u].items.length?h.appendChild(d):d.isConnected&&h.removeChild(d)},f=u=>{c.core.querySelector("select").value=u;[...t.children].forEach((A,B)=>{u===B?(A.classList.add("active"),A.removeEventListener("click",a)):(A.classList.remove("active"),A.addEventListener("click",a))})},q=(u,A=!0)=>{u?p.classList.add("on"):p.classList.remove("on");n=u;A&&h.dispatchEvent(new CustomEvent("GROUPS_CHECK",{detail:n}))},
v=(u,A=!0)=>{u?e.classList.add("on"):e.classList.remove("on");w=u;A&&h.dispatchEvent(new CustomEvent("GROUPS_VISIBILITY",{detail:w}))},a=u=>m(r.get(u.currentTarget)),k=({element:u})=>m(Number(u.value)),l=u=>q(!n),z=u=>v(!w);(h=x.appendChild(document.createElement("div"))).classList.add("files-group-nav");this.core=h;this.refresh=u=>{for(;h.firstChild;)h.removeChild(h.firstChild);y=null;b=u;console.log(b);1<b.length&&g(b);(d=document.createElement("div")).classList.add("controls");(p=d.appendChild(document.createElement("div"))).classList.add(...["control",
"controls-check"]);p.addEventListener("click",l);q(!0,!1);(e=d.appendChild(document.createElement("div"))).classList.add(...["control","controls-visibility"]);e.addEventListener("click",z);v(!0,!1);m()}},ModuleCompilerFileManagerGroupTree=function({data:x,target:y}){let h,b,r,n,w;const t=(a,k=!0)=>{k&&!n.has(a)?(n.set(a,b.get(a).data),r.delete(a)):k||r.has(a)||(r.set(a,b.get(a).data),n.delete(a));b.get(a).parents&&b.get(a).parents.forEach(l=>{var z;if(!(z=k)&&(z=!k)){a:{z=b.get(l).children;let u;
for(u=0;u<z.length;u+=1)if(n.has(z[u])){z=!0;break a}z=!1}z=!z}z&&c(l,k,!1)});d(a,k)},c=(a,k=!0,l=!0)=>{l&&b.get(a).children.forEach(z=>{b.get(z).children?c(z,k):t(z,k)});d(a,k)},d=(a,k)=>{k?b.get(a).node.classList.add("on"):b.get(a).node.classList.remove("on")},p=(a=!0)=>a&&n.size||!a&&r.size?a?n:r:!1,e=()=>({active:p(),inactive:p(!1),leaf:w.size,selected:n.size}),g=(a,k)=>{k=void 0!==k?k:b.get(a).children?!b.get(a).node.classList.contains("on"):!n.has(a);b.get(a).children?c(a,k):t(a,k)},m=(a,k)=>
{let l,z=k?k+"_":"i",u,A,B;u=document.createElement("ul");a.forEach((C,D)=>{l=z+D;(A=u.appendChild(document.createElement("li"))).classList.add(...["node",l]);(B=A.appendChild(f(C))).classList.add("trigger");b.set(l,{data:C,node:A});b.set(A,l);C.children?(A.appendChild(m(C.children,l)).classList.add("branch"),B.addEventListener("click",q)):(A.addEventListener("click",v),A.classList.add("leaf"),w.set(A,C));k?(l.split("_").slice(0,-1).forEach((G,E,F)=>(b.get(l).parents=b.get(l).parents||[]).push(F.slice(0,
E+1).join("_"))),(b.get(k).children=b.get(k).children||[]).push(l)):g(l)});return u},f=a=>{let k="string"===typeof a?a:a.name||a.vanity,l=document.createElement("span");l.textContent=k;a.path&&l.setAttribute("data-path",a.path);return l},q=a=>{a=b.get(a.currentTarget.parentNode);g(a);h.dispatchEvent(new CustomEvent("GROUP_TREE_CHANGE",{bubbles:!0,detail:e()}))},v=a=>{a=b.get(a.currentTarget);g(a);h.dispatchEvent(new CustomEvent("GROUP_TREE_CHANGE",{bubbles:!0,detail:e()}))};this.activate=(a=!0,k=
!0)=>{x.forEach((l,z)=>g(`i${z}`,a));k&&(console.log("werewr"),h.dispatchEvent(new CustomEvent("GROUP_TREE_CHANGE",{bubbles:!0,detail:e()})))};this.active=p;b=new Map;r=new Map;n=new Map;w=new Map;(h=y.appendChild(m(x))).classList.add("tree");this.core=h},ModuleCompilerFileManager=function({prefix:x,target:y}){let h,b,r,n;const w=c=>{c.stopImmediatePropagation();switch(c.type){case "GROUPS_CHECK":b.forEach(d=>d.check(c.detail,!0,!1));h.dispatchEvent(new CustomEvent("FILES"));break;case "GROUPS_VISIBILITY":b.forEach(d=>
d.visible(c.detail))}},t=c=>{c.stopImmediatePropagation();h.dispatchEvent(new CustomEvent("FILES"))};(h=y.appendChild(document.createElement("div"))).classList.add(`${x}-files`);r=new ModuleCompilerFileManagerGroupsNav({target:h});["GROUPS_CHECK","GROUPS_VISIBILITY"].forEach(c=>r.core.addEventListener(c,w));(n=h.appendChild(document.createElement("div"))).classList.add("inner");this.core=h;this.get=()=>{let c=[],d;b.forEach((p,e)=>{if(p.active()){if(d=p.active(!1),c[e]={},d){c[e].exclude=[];for(const g of d.values())c[e].exclude.push(g.path||
g)}}else c[e]=!1});return c};this.refresh=c=>{for(b=[];n.firstChild;)n.removeChild(n.firstChild);c.forEach((d,p)=>{b[p]=new ModuleCompilerFileManagerGroup({data:d,target:n});b[p].core.addEventListener("GROUP_TREE_CHANGE",t)})};this.start=c=>{r.refresh(c.groups);h.setAttribute("data-title",c.label)}},ModuleCompilerFilterCollection=function({data:x,prefix:y,target:h}){let b;(b=h.appendChild(document.createElement("div"))).classList.add(`${y}-collections`);new ModuleCompilerForm({target:b,data:[{type:"select",
values:x,change:({element:r})=>{b.dispatchEvent(new CustomEvent("COLLECTIONS",{detail:r.value}))}}]});this.core=b},ModuleCompilerFormLabelAlign={LEFT:"left",LEFT_WRAP:"left-wrap",RIGHT:"right",RIGHT_WRAP:"right-wrap"},ModuleCompilerForm=function({data:x,target:y}){let h,b;const r=this,n=(e,g)=>{e.forEach(m=>{let f;if(m instanceof Array||m.type.match(/(field)?set/))f=g.appendChild(document.createElement(m.tag||"fieldset")),n(m.fields||m,f);else{switch(m.type){case "select":f=w({elementData:m.values,
blank:m.blank});break;default:f=document.createElement("input")}f.classList.add("p-modulecompiler-form-element")}g.appendChild(f);void 0!==m.label&&t(m.label,f);c(f,m)})},w=({elementData:e,elementParent:g,elementParentID:m,blank:f=!0})=>{let q=g||document.createElement("select");!g&&f&&q.appendChild(document.createElement("option"));e.forEach((v,a)=>{let k=`${m?`${m}_`:"i"}${a}`,l;v.values||v instanceof Array?(l=v.values&&(v.label||v.name)?v.label||v.name:`group${a}`,v=v.values||v,(a=q.appendChild(document.createElement("optgroup"))).setAttribute("label",
l),w({elementData:v,elementParent:a,elementParentID:k})):(l=p([v.label,v.name,v.value,v]),(a=q.appendChild(document.createElement("option"))).value=p([v.value,l]),a.textContent=l,b.set(a,k))});return q},t=(e,g,m=ModuleCompilerFormLabelAlign.LEFT)=>{m=e.align||m;let f=document.createElement("label"),q=`p-modulecompiler-form-element-${Date.now()+Math.floor(256*Math.random())}`;d(g,{id:q});d(f,{"for":q,"align-type":m});f.textContent=e.name||e;switch(m){case ModuleCompilerFormLabelAlign.LEFT:g.parentNode.insertBefore(f,
g);break;case ModuleCompilerFormLabelAlign.LEFT_WRAP:g.parentNode.appendChild(f).appendChild(g);break;case ModuleCompilerFormLabelAlign.RIGHT:g.parentNode.insertBefore(f,g.nextSibling);break;case ModuleCompilerFormLabelAlign.RIGHT_WRAP:g.parentNode.appendChild(f).prepend(g)}f.classList.add(`align-${m}`);return f},c=(e,g)=>{let m={};if(!g.type||g.type.match(/((field)?set|checkbox|radio|text)/))if(!g.type.match(/(field)?set/)||g.tag)m.type=g.type||"text";void 0!==g.name&&(m.name=g.name);void 0!==g.change&&
e.addEventListener("change",f=>g.change({data:g,form:h,element:e,obj:r}));void 0!==g.value&&(m.value=g.value);g.type.match(/(checkbox|radio)/)&&g.checked&&(m.checked=!0);d(e,m)},d=(e,g)=>Object.entries(g).forEach(([m,f])=>e.setAttribute(m,f)),p=e=>{let g;for(const m of e)if(g=m,void 0!==g)break;return g};x&&(b=new Map,r.core=h=y.appendChild(document.createElement("form")),n(x,h))},ModuleCompilerPreferences=function({prefix:x,target:y}){let h,b;const r="ECMASCRIPT_2021 ECMASCRIPT_2020 ECMASCRIPT_2019 ECMASCRIPT_2018 ECMASCRIPT_2017 ECMASCRIPT_2016 ECMASCRIPT6 ECMASCRIPT5".split(" "),
n=()=>{let d={returnType:t("[name=returnType]:checked").value};d.returnType.match(/join/)&&t("[name=minify]").checked&&(d={...d,minify:1,language:t("[name=language]").value,language_out:t("[name=language_out]").value});return d},w=({type:d,returnTypes:p}={})=>{p&&t("[name=returnType]",!0).forEach(e=>{e.disabled=!p.includes(e.value)});t("[type=set]:not([name=main])",!0).forEach(e=>{t("[name=returnType]:checked").value===e.getAttribute("name")?e.classList.add("on"):e.classList.remove("on")});["language",
"language_out"].forEach(e=>{e=t(`[name="join"] [name=${e}]`);e.disabled=!t('[name="join"] [name=minify]').checked;if(d)e.classList[d.match(/js/)?"remove":"add"]("off")});b.core.querySelectorAll("[id]").forEach(e=>{let g=t(`label[for=${e.id}]`),m;g&&(m=[[e.disabled?"add":"remove","disabled"]],d&&m.push([e.classList.contains("off")?"add":"remove","off"]),m.forEach(f=>g.classList[f[0]](f[1])))})},t=(d,p=!1)=>b.core[p?"querySelectorAll":"querySelector"](d),c=d=>{w();d=n("minify").checked;h.dispatchEvent(new CustomEvent("PREFERENCES",
{detail:{load:d}}))};(h=y.appendChild(document.createElement("div"))).classList.add(`${x}-preferences`);b=new ModuleCompilerForm({target:h,data:[{type:"set",name:"main",tag:"div",fields:[{name:"returnType",type:"radio",label:{name:"Link",align:"right"},value:"link",checked:!0,change:c},{name:"returnType",type:"radio",label:{name:"Join",align:"right"},value:"join",change:c},{name:"returnType",type:"radio",label:{name:"Closure",align:"right"},value:"closure",change:c}]},{type:"set",name:"join",tag:"div",
fields:[{name:"minify",type:"checkbox",label:{name:"Minify",align:ModuleCompilerFormLabelAlign.RIGHT_WRAP},change:c},{name:"language",type:"select",values:r,blank:!1,label:{name:"Language",align:ModuleCompilerFormLabelAlign.LEFT_WRAP},change:c},{name:"language_out",type:"select",values:r,blank:!1,label:{name:"Language Out",align:ModuleCompilerFormLabelAlign.LEFT_WRAP},change:c}]}]});w();this.core=h;this.get=n;this.refresh=(d,p)=>w({type:d,returnTypes:p});this.wait=()=>n().minify},ModuleCompilerResultManager=
function({prefix:x,target:y}){var h,b,r;const n={compiled_code:"Compiled Code",errors:"Errors",result:"Result",warnings:"Warnings",statistics:"Statistics"},w=(c,d=!0)=>{if(!d||d&&c!==h){d&&(h&&w(h,!1),h=c);let p=r.get(c).nav.classList;c=r.get(c).content.classList;d?(p.add("active"),c.add("on")):(p.remove("active"),c.remove("on"))}},t=c=>{h=void 0;for(r=new Map;b.firstChild;)b.removeChild(b.firstChild);let d,p,e,g,m;(d=b.appendChild(document.createElement("ul"))).classList.add(`${x}-result-nav`);(g=
b.appendChild(document.createElement("div"))).classList.add(`${x}-result-content`);Object.entries(c).forEach(([f,q])=>{(p=d.appendChild(document.createElement("li"))).classList.add(`${x}-result-nav-item`);(e=p.appendChild(document.createElement("a"))).textContent=n[f]||f;e.setAttribute("href","#");e.addEventListener("click",v=>w(v.currentTarget));(m=g.appendChild(document.createElement("div"))).classList.add(`${x}-result-content-item`);m.appendChild(document.createElement("textarea")).textContent=
q;r.set(e,{nav:p,content:m})})};(b=y.appendChild(document.createElement("div"))).classList.add(`${x}-result`);this.refresh=c=>{t("string"===typeof c?{result:c}:c);w(r.keys().next().value)}},ModuleCompilerSystemStatus=function({app:x,prefix:y,target:h}){let b;(b=h.appendChild(document.createElement("div"))).classList.add(`${y}-systemstatus`);b.appendChild(document.createElement("div")).classList.add(`${y}-systemstatus-indicator`);this.set=(r,n=!0)=>{b.classList[n?"add":"remove"]("on");x.core.classList[n?
"add":"remove"](`status-${r}`)}},ModuleDataManager=function({data:x,handler:y,prefix:h,process:b}){var r,n;let w,t,c;const d=this,p=(f,...q)=>{let v=new FormData;q.forEach(a=>{for(let k in a)if(a.hasOwnProperty(k)){let l=a[k];"object"===typeof l&&(l=JSON.stringify(l));v.append(k,l)}});return new Request(f,{body:v,method:"POST"})},e=async f=>{r=new Map;n=new Map;w=new Map;t=new Map;"object"===typeof f?c=g(f):"string"===typeof f&&(c=await fetch(f).then(q=>q.json()).then(q=>g(q)));y&&y(d)},g=(f,q)=>
{let v=[];f.forEach((a,k)=>{let l=`${q?`${q}_`:"i"}${k}`;if(a.values||Array.isArray(a))k=g(a.values||a,l),v.push({name:a.label,values:k});else{let z=[],u;k=a.data;let A=["join","link"];Array.isArray(k)&&(Array.isArray(k[0])||k[0].group&&k[0].items)?k.forEach((B,C)=>{u={id:l+"_"+C,type:B.type||a.type||"js",name:B.group||"Group "+C,items:Array.isArray(B)?B:Array.isArray(B.items)?B.items:[B.items]};z.push(u);m(u)}):(u={id:l+"_0",type:a.type||"js",name:"Group 0",items:Array.isArray(k)?k:[k]},z.push(u),
m(u));z.forEach(B=>{t.set(B.id,B);B.returnTypes=[].concat(A);for(let C=0;C<B.items.length;C+=1)if(B.items[C].closure){B.returnTypes.push("closure");break}});w.set(l,{groups:z,label:a.label});v.push({name:a.label,value:l})}});void 0===q&&n.forEach((a,k)=>{r.has(k)&&a.forEach(l=>{l.group.items[l.index]=r.get(k)})});return v},m=f=>{f.items.forEach((q,v)=>{if("string"===typeof q){let a=n;a.has(q)||a.set(q,[]);a.set(q,[...a.get(q),{group:f,index:v}])}else q.alias&&r.set(q.alias,q)})};d.load=(f,q,v,a)=>
{let k=[];f=t.get(f);f.items.forEach((l,z)=>{a&&!a[z]||k.push({exclude:a&&a[z].exclude,filter:l.filter,join:l.join,name:l.name,path:(h||"")+l.path,prefix:v.returnType.match(/link/)&&l[v.returnType]||"",top:l.top})});f=p(b,v,{data:k,type:f.type});fetch(f).then(l=>l.json()).then(l=>q(l))};d.filter=()=>c;d.collection=f=>w.get(f);d.returnTypes=f=>t.get(f).returnTypes;d.type=f=>t.get(f).type;x&&e(x)};
